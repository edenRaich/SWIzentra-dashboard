<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Device Sensor Charts - All Sites</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; }
    .site-section { background: #fff; margin: 30px auto; padding: 20px; border-radius: 6px; box-shadow: 0 2px 8px rgb(0 0 0 / 0.1); max-width: 900px; }
    h2 { text-align: center; }
    .chart-wrapper { margin: 30px 0; }
    canvas { width: 100% !important; height: 300px !important; }
  </style>
</head>
<body>
  <h2>Device Sensor Charts: All Sites</h2>
  <div id="sites-container"></div>

  <script>
    const siteMap = {
      "z6-33252": "Ghost Forest",
      "z6-33251": "Murphy Cemetery",
      "z6-32482": "Nibble Fish Corner",
      "z6-32414": "B & K Styron Yard"
    };
    const proxyUrl = "https://zentra-proxy.onrender.com/zentra";

    function parseDateTime(datetimeStr) {
      return new Date(datetimeStr);
    }

    async function fetchSensorReadings(device_sn) {
      const response = await fetch(`${proxyUrl}?device_sn=${encodeURIComponent(device_sn)}`);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const json = await response.json();
      return json.data || {};
    }

    async function renderSiteCharts(device_sn, site_name) {
      const container = document.getElementById("sites-container");
      const section = document.createElement("div");
      section.className = "site-section";
      section.innerHTML = `<h3>${site_name}</h3>
        <div class="chart-wrapper"><canvas id="batteryChart_${device_sn}"></canvas></div>
        <div class="chart-wrapper" id="otherCharts_${device_sn}"></div>`;
      container.appendChild(section);

      try {
        const data = await fetchSensorReadings(device_sn);

        // Battery chart
        const batterySensor = data["Battery Percent"];
        if (batterySensor && batterySensor[0]?.readings) {
          const batteryReadings = batterySensor[0].readings;
          const batteryLabels = batteryReadings.map(r => parseDateTime(r.datetime));
          const batteryValues = batteryReadings.map(r => r.value);

          const batteryCtx = document.getElementById(`batteryChart_${device_sn}`).getContext("2d");
          new Chart(batteryCtx, {
            type: "line",
            data: {
              labels: batteryLabels,
              datasets: [{
                label: "Battery Percentage (%)",
                data: batteryValues,
                fill: false,
                borderColor: "rgba(75, 192, 192, 1)",
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                tension: 0.1,
                pointRadius: 2,
                pointHoverRadius: 5,
              }]
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  type: "time",
                  time: { tooltipFormat: "PPpp", unit: "hour", displayFormats: { hour: "MMM d, HH:mm" } },
                  title: { display: true, text: "Timestamp" }
                },
                y: {
                  beginAtZero: true,
                  max: 100,
                  title: { display: true, text: "Battery Percentage (%)" }
                }
              },
              plugins: {
                legend: { display: true },
                tooltip: { mode: "index", intersect: false }
              }
            }
          });
        }

        // Other sensors
        const otherSensorNames = Object.keys(data).filter(name => name !== "Battery Percent");
        const otherChartsDiv = document.getElementById(`otherCharts_${device_sn}`);
        otherSensorNames.forEach((sensorName, idx) => {
          const sensorData = data[sensorName][0];
          if (!sensorData?.readings) return;

          const readings = sensorData.readings;
          const labels = readings.map(r => parseDateTime(r.datetime));
          const values = readings.map(r => r.value);
          const units = sensorData.metadata?.units || "";

          const wrapper = document.createElement("div");
          wrapper.className = "chart-wrapper";
          const title = document.createElement("h4");
          title.textContent = `${sensorName}${units ? " (" + units + ")" : ""}`;
          const canvas = document.createElement("canvas");
          canvas.id = `sensorChart_${device_sn}_${idx}`;
          wrapper.appendChild(title);
          wrapper.appendChild(canvas);
          otherChartsDiv.appendChild(wrapper);

          const ctx = canvas.getContext("2d");
          new Chart(ctx, {
            type: "line",
            data: {
              labels: labels,
              datasets: [{
                label: sensorName + (units ? ` (${units})` : ""),
                data: values,
                fill: false,
                borderColor: "rgba(54, 162, 235, 1)",
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                tension: 0.1,
                pointRadius: 2,
                pointHoverRadius: 5,
              }]
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  type: "time",
                  time: { tooltipFormat: "PPpp", unit: "hour", displayFormats: { hour: "MMM d, HH:mm" } },
                  title: { display: true, text: "Timestamp" }
                },
                y: {
                  beginAtZero: false,
                  title: { display: true, text: units ? units : "Value" }
                }
              },
              plugins: {
                legend: { display: true },
                tooltip: { mode: "index", intersect: false }
              }
            }
          });
        });
      } catch (error) {
        section.innerHTML += `<div style="color:red;">Error loading data: ${error.message}</div>`;
      }
    }

    // Render charts for all sites
    Object.entries(siteMap).forEach(([device_sn, site_name]) => {
      renderSiteCharts(device_sn, site_name);
    });
  </script>
</body>
</html>
