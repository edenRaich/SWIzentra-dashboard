<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdn.jsdelivr.net https://unpkg.com;
    style-src 'self' 'unsafe-inline' https://unpkg.com;
    img-src 'self' data: https://unpkg.com https://*.tile.openstreetmap.org;
    font-src 'self' https://unpkg.com;
    connect-src 'self' https://cdn.jsdelivr.net https://unpkg.com;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
  ">
  <title>Zentra Sites Map & Sensor Data</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 400px; margin-bottom: 24px; }
    .site-title { font-size: 1.2em; font-weight: bold; margin-top: 16px; }
    .sensor-chart-block { margin-bottom: 40px; }
    .sensor-title { font-weight: bold; margin-bottom: 4px; margin-top: 16px; }
    .chart-container { margin-bottom: 32px; }
    #charts { margin-top: 24px; }
  </style>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Date adapter for Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <h2>Zentra Sites Map & Sensor Data</h2>
  <div id="map"></div>
  <div id="charts"></div>

  <script>
    // Site/device info
    const sites = [
      {
        name: "Ghost Forest",
        sn: "z6-33252",
        lat: 34.7883175,
        lng: -76.4653989
      },
      {
        name: "Murphy Cemetery",
        sn: "z6-33251",
        lat: 34.789873,
        lng: -76.4655548
      },
      {
        name: "Tidal Ditch",
        sn: "z6-32482",
        lat: 34.7855122,
        lng: -76.4655264
      },
      {
        name: "Styron Yard",
        sn: "z6-32414",
        lat: 34.789731,
        lng: -76.4612296
      }
    ];

    // Helper: Choose proxy URL based on environment
    const baseUrl = (window.location.hostname === 'localhost')
      ? 'http://localhost:3000'
      : 'https://zentra-proxy.onrender.com';

    // Initialize map
    const map = L.map('map').setView([34.788, -76.464], 15);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Add markers for each site
    sites.forEach(site => {
      const marker = L.marker([site.lat, site.lng]).addTo(map);
      marker.bindPopup(`<b>${site.name}</b><br>SN: ${site.sn}`);
      marker.on('click', () => showSiteData(site));
    });

    // Store chart instances to destroy them before drawing new ones
    let chartInstances = [];

    async function showSiteData(site) {
      document.getElementById('charts').innerHTML = `<div class="site-title">${site.name} (SN: ${site.sn})</div><div>Loading data...</div>`;
      // Destroy previous charts
      chartInstances.forEach(chart => chart.destroy());
      chartInstances = [];
      try {
        const url = `${baseUrl}/zentra?device_sn=${site.sn}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to fetch data');
        const data = await res.json();
        const device = (data.devices && data.devices[0]) || {};
        if (!device.data) {
          document.getElementById('charts').innerHTML = `<div class="site-title">${site.name} (SN: ${site.sn})</div><div>No data available.</div>`;
          return;
        }
        // Build charts for each sensor
        let chartsHtml = `<div class="site-title">${site.name} (SN: ${site.sn})</div>`;
        Object.entries(device.data).forEach(([sensorName, sensorArr]) => {
          if (Array.isArray(sensorArr) && sensorArr.length > 0) {
            const readings = sensorArr[0].readings || [];
            const units = (sensorArr[0].metadata && sensorArr[0].metadata.units) || '';
            if (readings.length > 0) {
              const chartId = `chart-${site.sn}-${sensorName.replace(/\s+/g, '_')}`;
              chartsHtml += `
                <div class="sensor-chart-block">
                  <div class="sensor-title">${sensorName} ${units ? '(' + units + ')' : ''}</div>
                  <canvas id="${chartId}" height="300"></canvas>
                </div>
              `;
            }
          }
        });
        document.getElementById('charts').innerHTML = chartsHtml;

        // Now render charts
        Object.entries(device.data).forEach(([sensorName, sensorArr]) => {
          if (Array.isArray(sensorArr) && sensorArr.length > 0) {
            const readings = sensorArr[0].readings || [];
            const units = (sensorArr[0].metadata && sensorArr[0].metadata.units) || '';
            if (readings.length > 0) {
              const chartId = `chart-${site.sn}-${sensorName.replace(/\s+/g, '_')}`;
              const ctx = document.getElementById(chartId).getContext('2d');
              const chart = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: readings.map(r => r.datetime),
                  datasets: [{
                    label: sensorName,
                    data: readings.map(r => r.value),
                    fill: false,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                  }]
                },
                options: {
                  responsive: true,
                  scales: {
                    x: {
                      type: 'time',
                      time: {
                        parser: 'yyyy-MM-dd HH:mm:ssXXX',
                        tooltipFormat: 'PP HH:mm',
                        unit: 'hour',
                        displayFormats: {
                          hour: 'MMM d, HH:mm'
                        }
                      },
                      title: {
                        display: true,
                        text: 'Timestamp'
                      }
                    },
                    y: {
                      beginAtZero: false,
                      title: {
                        display: true,
                        text: units || sensorName
                      }
                    }
                  },
                  plugins: {
                    legend: { display: true },
                    tooltip: { mode: 'index', intersect: false }
                  }
                }
              });
              chartInstances.push(chart);
            }
          }
        });
      } catch (err) {
        document.getElementById('charts').innerHTML = `<div class="site-title">${site.name} (SN: ${site.sn})</div><div style="color:red;">${err.message}</div>`;
      }
    }

    // Optionally, show the first site's data on load
    showSiteData(sites[0]);
  </script>
</body>
</html>
